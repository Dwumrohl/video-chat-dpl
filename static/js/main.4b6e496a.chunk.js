(this["webpackJsonpvideo-chat-dpl"]=this["webpackJsonpvideo-chat-dpl"]||[]).push([[0],{57:function(e,t,n){},59:function(e,t,n){},65:function(e,t,n){},66:function(e,t,n){},70:function(e,t,n){},71:function(e,t,n){},72:function(e,t,n){},73:function(e,t,n){},74:function(e,t,n){},75:function(e,t,n){},76:function(e,t,n){"use strict";n.r(t),n.d(t,"store",(function(){return de}));var r=n(5),a=n.n(r),c=n(38),i=n.n(c),s=(n(57),n(12)),o=n(0),u=n.n(o),d=n(3),j=n(49),b=n(19),l=n(26),p=n(17),f=Object(j.a)({apiKey:"AIzaSyCZzeoeLPf9RygQgYkvEI6q5c490KYeChY",authDomain:"test-video-chat-4979b.firebaseapp.com",projectId:"test-video-chat-4979b",storageBucket:"test-video-chat-4979b.appspot.com",messagingSenderId:"249820721403",appId:"1:249820721403:web:9ce311e53144626720c05e",databaseURL:"https://test-video-chat-4979b-default-rtdb.europe-west1.firebasedatabase.app/"}),O=Object(b.g)(),v=Object(l.d)(f),m=Object(p.i)(Object(p.b)());function h(){return x.apply(this,arguments)}function x(){return(x=Object(d.a)(u.a.mark((function e(){var t,n,r,a;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=new b.c,e.next=4,Object(b.o)(O,t);case 4:return n=e.sent,r=n.user,a=Object(l.e)(Object(l.b)(v,"users"),Object(l.f)("uid","==",r.uid)),e.next=9,Object(l.c)(a);case 9:if(0!==e.sent.docs.length){e.next=13;break}return e.next=13,Object(l.a)(Object(l.b)(v,"users"),{uid:r.uid,name:r.displayName,authProvider:"google",email:r.email});case 13:return e.abrupt("return",{uid:r.uid,displayName:r.displayName});case 16:return e.prev=16,e.t0=e.catch(0),"auth/cancelled-popup-request"!==e.t0.code&&console.error(e.t0),e.abrupt("return",null);case 20:case"end":return e.stop()}}),e,null,[[0,16]])})))).apply(this,arguments)}Object(b.h)(O,(function(e){}));var g=function(){Object(b.p)(O)},y=m,w=n(13),k=(n(59),n(11));function U(){var e=Object(r.useState)(""),t=Object(s.a)(e,2),n=t[0],a=t[1],c=null,i=Object(w.m)();return Object(k.jsx)("div",{className:"main",children:Object(k.jsxs)("div",{className:"inner",children:[Object(k.jsx)("h3",{className:"welcome",children:"\u0414\u043e\u0431\u0440\u043e \u043f\u043e\u0436\u0430\u043b\u043e\u0432\u0430\u0442\u044c \u0432 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u0434\u043b\u044f \u0432\u0438\u0434\u0435\u043e\u0441\u0432\u044f\u0437\u0438!"}),Object(k.jsx)("div",{className:"divCreate",children:Object(k.jsx)("button",{className:"btns",onClick:function(){c=function(){var e=new URLSearchParams(window.location.search).get("id");return(m=e?Object(p.a)(m,e):Object(p.h)(m)).key}(),localStorage.setItem("roomId",c),i("/room/"+c)},children:"\u0421\u043e\u0437\u0434\u0430\u0442\u044c \u043a\u043e\u043c\u043d\u0430\u0442\u0443"})}),Object(k.jsx)("div",{className:"forma",children:Object(k.jsxs)("form",{onSubmit:function(e){e.preventDefault(),localStorage.setItem("roomId",n),i("/room/"+n)},children:[Object(k.jsx)("label",{className:"labelRoom",children:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043d\u043e\u043c\u0435\u0440 \u043a\u043e\u043c\u043d\u0430\u0442\u044b:"}),Object(k.jsx)("div",{className:"inputRoom",children:Object(k.jsx)("input",{type:"text",value:n,onChange:function(e){return a(e.target.value)},required:!0,placeholder:"\u041d\u043e\u043c\u0435\u0440...",className:"inputRoom"})}),Object(k.jsx)("input",{className:"btns",type:"submit",value:"\u0412\u043e\u0439\u0442\u0438"})]})}),Object(k.jsx)("div",{className:"divOut",children:Object(k.jsx)("button",{className:"leaveBtn",onClick:g,children:"\u0412\u044b\u0445\u043e\u0434 \u0438\u0437 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430"})})]})})}var C=n(33),S=n(6),N=n(16),I=n(31),T=n(27),P=n(50),R=(n(65),function(e){var t=Object(w.m)(),n=Object(r.useState)({mic:!0,video:!1,screen:!1}),a=Object(s.a)(n,2),c=a[0],i=a[1],o=function(e){i((function(t){return Object(N.a)(Object(N.a)({},t),{},{screen:e})}))};return Object(r.useEffect)((function(){e.onMicClick(c.mic)}),[c.mic]),Object(r.useEffect)((function(){e.onVideoClick(c.video)}),[c.video]),Object(k.jsxs)("div",{className:"meeting-footer",children:[Object(k.jsx)("div",{className:"meeting-icons "+(c.mic?"":"active"),"data-tip":c.mic?"\u0412\u044b\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u043c\u0438\u043a\u0440\u043e\u0444\u043e\u043d":"\u0412\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u043c\u0438\u043a\u0440\u043e\u0444\u043e\u043d",onClick:function(){i((function(e){return Object(N.a)(Object(N.a)({},e),{},{mic:!e.mic})}))},children:Object(k.jsx)(I.a,{icon:c.mic?T.b:T.c,title:"Mute"})}),Object(k.jsx)("div",{className:"meeting-icons "+(c.video?"":"active"),"data-tip":c.video?"\u0412\u044b\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u043a\u0430\u043c\u0435\u0440\u0443":"\u0412\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u043a\u0430\u043c\u0435\u0440\u0443",onClick:function(){i((function(e){return Object(N.a)(Object(N.a)({},e),{},{video:!e.video})}))},children:Object(k.jsx)(I.a,{icon:c.video?T.e:T.f})}),Object(k.jsx)("div",{className:"meeting-icons","data-tip":"\u0414\u0435\u043c\u043e\u043d\u0441\u0442\u0440\u0430\u0446\u0438\u044f \u044d\u043a\u0440\u0430\u043d\u0430",onClick:function(){e.onScreenClick(o)},disabled:c.screen,children:Object(k.jsx)(I.a,{icon:T.a})}),Object(k.jsx)("div",{onClick:function(){t("/"),window.location.reload(!1)},className:"meeting-icons","data-tip":"\u0412\u044b\u0439\u0442\u0438",children:Object(k.jsx)(I.a,{icon:T.d})}),Object(k.jsx)(P.a,{})]})}),M=(n(66),n(29)),D=(n(70),function(e){return Object(k.jsx)("div",{className:"card",children:e.children})}),E=(n(71),function(e){var t=e.curentIndex,n=e.currentParticipant,r=e.hideVideo,a=e.videoRef,c=e.showAvatar,i=e.currentUser;return n?Object(k.jsx)("div",{className:"participant ".concat(r?"hide":""),children:Object(k.jsxs)(D,{children:[Object(k.jsx)("video",{ref:a,className:"video",id:"participantVideo".concat(t),autoPlay:!0,playsInline:!0}),!n.audio&&Object(k.jsx)(I.a,{className:"muted",icon:T.c,title:"Muted"}),c&&Object(k.jsx)("div",{style:{background:n.avatarColor},className:"avatar",children:n.name[0]}),Object(k.jsxs)("div",{className:"name",children:[n.name,i?"(\u0412\u044b)":""]})]})}):Object(k.jsx)(k.Fragment,{})}),A=Object(M.b)((function(e){return{participants:e.participants,currentUser:e.currentUser,stream:e.mainStream}}))((function(e){var t=Object(r.useRef)(null),n=Object.keys(e.participants);Object(r.useEffect)((function(){t.current&&(t.current.srcObject=e.stream,t.current.muted=!0)}),[e.currentUser,e.stream]);var a=e.currentUser?Object.values(e.currentUser)[0]:null,c=1===n.length?1:n.length<=4?2:4,i=n.length<=4?1:2,s=n.length<=4?n.length:Math.ceil(n.length/2),o=n.find((function(t){return e.participants[t].screen}));o&&(c=1,s=2);var u=n.map((function(t,n){var r=e.participants[t];if(r.currentUser)return null;var a=r.peerConnection,c=new MediaStream,i=n;return a&&(a.ontrack=function(e){e.streams[0].getTracks().forEach((function(e){c.addTrack(e)}));var t=document.getElementById("participantVideo".concat(i));t&&(t.srcObject=c)}),Object(k.jsx)(E,{currentParticipant:r,curentIndex:i,hideVideo:o&&o!==t,showAvatar:!r.video&&!r.screen&&r.name},i)}));return Object(k.jsxs)("div",{style:{"--grid-size":c,"--grid-col-size":i,"--grid-row-size":s},className:"participants",children:[u,Object(k.jsx)(E,{currentParticipant:a,curentIndex:n.length,hideVideo:o&&!a.screen,videoRef:t,showAvatar:a&&!a.video&&!a.screen,currentUser:!0})]})})),V=(n(72),"SET_MAIN_STREAM"),L="ADD_PARTICIPANT",z="REMOVE_PARTICIPANT",_="SET_USER",F="UPDATE_USER",B="UPDATE_PARTICIPANT",J=function(e){return{type:V,payload:{mainStream:e}}},q=Object(M.b)((function(e){return{stream:e.mainStream,participants:e.participants,currentUser:e.currentUser}}),(function(e){return{setMainStream:function(t){return e(J(t))},updateUser:function(t){return e(function(e){return{type:F,payload:{currentUser:e}}}(t))}}}))((function(e){var t=Object(r.useRef)(e.participants);Object(r.useEffect)((function(){t.current=e.participants}),[e.participants]);var n=function(n){for(var r in t.current){var a=t.current[r];if(!a.currentUser)a.peerConnection.getSenders().find((function(e){return!!e.track&&"video"===e.track.kind})).replaceTrack(n.getVideoTracks()[0])}e.setMainStream(n)},a=function(){var t=Object(d.a)(u.a.mark((function t(){var r;return u.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,navigator.mediaDevices.getUserMedia({audio:!0,video:!0});case 2:(r=t.sent).getVideoTracks()[0].enabled=Object.values(e.currentUser)[0].video,n(r),e.updateUser({screen:!1});case 6:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),c=function(){var t=Object(d.a)(u.a.mark((function t(){var r;return u.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!navigator.getDisplayMedia){t.next=6;break}return t.next=3,navigator.getDisplayMedia({video:!0});case 3:r=t.sent,t.next=15;break;case 6:if(!navigator.mediaDevices.getDisplayMedia){t.next=12;break}return t.next=9,navigator.mediaDevices.getDisplayMedia({video:!0});case 9:r=t.sent,t.next=15;break;case 12:return t.next=14,navigator.mediaDevices.getUserMedia({video:{mediaSource:"screen"}});case 14:r=t.sent;case 15:r.getVideoTracks()[0].onended=a,n(r),e.updateUser({screen:!0});case 18:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();return Object(k.jsxs)("div",{className:"wrapper",children:[Object(k.jsx)("div",{className:"main-screen",children:Object(k.jsx)(A,{})}),Object(k.jsx)("div",{className:"footer",children:Object(k.jsx)(R,{onScreenClick:c,onMicClick:function(t){e.stream&&(e.stream.getAudioTracks()[0].enabled=t,e.updateUser({audio:t}))},onVideoClick:function(t){e.stream&&(e.stream.getVideoTracks()[0].enabled=t,e.updateUser({video:t}))}})})]})})),Y=(n(73),n(44)),K=a.a.createContext(),G=function(e){var t=Object(Y.a)(O),n=Object(s.a)(t,2),r=n[0],a=(n[1],function(){var e=Object(d.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h();case 2:e.sent;case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}());setTimeout(g,72e5);var c={user:r,login:a};return Object(k.jsx)(K.Provider,Object(N.a)({value:c},e))};function Q(){var e=a.a.useContext(K);if(!e)throw new Error("AuthContext's value is undefined.");return e}var Z=Object(M.b)((function(e){return{stream:e.mainStream,user:e.currentUser}}),(function(e){return{setMainStream:function(t){return e(J(t))},addParticipant:function(t){return e(function(e){return{type:L,payload:{newUser:e}}}(t))},setUser:function(t){return e(function(e){return{type:_,payload:{currentUser:e}}}(t))},removeParticipant:function(t){return e(function(e){return{type:z,payload:{id:e}}}(t))},updateParticipant:function(t){return e(function(e){return{type:B,payload:{newUser:e}}}(t))}}}))((function(e){var t=Object(w.k)(),n=Object(w.m)(),a=localStorage.getItem("roomId"),c=t.pathname.split("/"),i=c[c.length-1];a!=i&&n("/");var s=Q().user.displayName,o=function(){var e=Object(d.a)(u.a.mark((function e(){var t;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.getUserMedia({audio:!0,video:!0});case 2:return t=e.sent,e.abrupt("return",t);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();Object(r.useEffect)(Object(d.a)(u.a.mark((function t(){var n;return u.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o();case 2:(n=t.sent).getVideoTracks()[0].enabled=!1,e.setMainStream(n),Object(p.g)(b,(function(t){if(!0===t.val()){var n={audio:!0,video:!1,screen:!1},r=Object(p.h)(f,{userName:s,preferences:n});e.setUser(Object(S.a)({},r.key,Object(N.a)({name:s},n))),Object(p.f)(r).remove()}}));case 6:case"end":return t.stop()}}),t)}))),[]);var j=Object(p.b)(),b=Object(p.i)(j,".info/connected"),l=Object(p.a)(y,i),f=Object(p.a)(l,"participants"),O=!!e.user,v=!!e.stream;return Object(r.useEffect)((function(){v&&O&&(Object(p.c)(f,(function(t){var n=Object(p.a)(f,t.key),r=Object(p.a)(n,"preferences");Object(p.d)(r,(function(n){e.updateParticipant(Object(S.a)({},t.key,Object(S.a)({},n.key,n.val())))}));var a=t.val(),c=a.userName,i=a.preferences,s=void 0===i?{}:i;e.addParticipant(Object(S.a)({},t.key,Object(N.a)({name:c},s)))})),Object(p.e)(f,(function(t){e.removeParticipant(t.key)})))}),[v,O]),Object(k.jsx)("div",{className:"App",children:Object(k.jsx)(q,{})})}));function H(){return Object(k.jsx)(C.a,{children:Object(k.jsxs)(w.c,{children:[Object(k.jsx)(w.a,{exact:!0,path:"/room/:id",element:Object(k.jsx)(Z,{})}),Object(k.jsx)(w.a,{exact:!0,path:"/",element:Object(k.jsx)(U,{})})]})})}n(74);function W(){var e=Q().login,t=Object(r.useState)(""),n=Object(s.a)(t,2),a=(n[0],n[1],Object(r.useState)("")),c=Object(s.a)(a,2),i=(c[0],c[1],Object(Y.a)(O)),o=Object(s.a)(i,3);o[0],o[1],o[2];return Object(k.jsxs)(k.Fragment,{children:[Object(k.jsx)("h2",{className:"unauthLbl",children:"\u041d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u043e \u043f\u0440\u043e\u0438\u0437\u0432\u0435\u0441\u0442\u0438 \u0432\u0445\u043e\u0434"}),Object(k.jsx)("div",{children:Object(k.jsx)("div",{className:"login",children:Object(k.jsx)("button",{onClick:e,className:"login",children:"\u0412\u043e\u0439\u0442\u0438 \u0441 \u043f\u043e\u043c\u043e\u0449\u044c\u044e Google"})})})]})}n(75);var X=function(){var e=Q().user;return Object(k.jsx)("div",{className:"container",children:e?Object(k.jsx)(H,{}):Object(k.jsx)(W,{})})},$=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,79)).then((function(t){var n=t.getCLS,r=t.getFID,a=t.getFCP,c=t.getLCP,i=t.getTTFB;n(e),r(e),a(e),c(e),i(e)}))},ee=n(52),te=null,ne=function(e,t){var n=Object(p.a)(te,e),r=Object(p.a)(n,"preferences");setTimeout((function(){Object(p.k)(r,t)}))},re=function(){var e=Object(d.a)(u.a.mark((function e(t,n,r){var a,c,i;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object(p.a)(te,n),t.onicecandidate=function(e){e.candidate&&Object(p.h)(Object(p.a)(a,"offerCandidates"),Object(N.a)(Object(N.a)({},e.candidate.toJSON()),{},{userId:r}))},e.next=4,t.createOffer();case 4:return c=e.sent,e.next=7,t.setLocalDescription(c);case 7:return i={sdp:c.sdp,type:c.type,userId:r},e.next=10,Object(p.j)(Object(p.h)(Object(p.a)(a,"offers")),{offer:i});case 10:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),ae=function(){var e=Object(d.a)(u.a.mark((function e(t){var n,r,a,c,i;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=window.location.hash.split("/"),r=n[n.length-1],a=Object(p.a)(y,r),te=Object(p.a)(a,"participants"),c=Object(p.a)(te,t),i=Object(p.a)(c,"offers"),Object(p.c)(i,function(){var e=Object(d.a)(u.a.mark((function e(n){var r,a;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(null===(r=n.val())||void 0===r?void 0:r.offer)){e.next=7;break}return a=de.getState().participants[r.offer.userId].peerConnection,e.next=5,a.setRemoteDescription(new RTCSessionDescription(r.offer));case 5:return e.next=7,ce(r.offer.userId,t);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),Object(p.c)(Object(p.a)(c,"offerCandidates"),(function(e){var t=e.val();t.userId&&de.getState().participants[t.userId].peerConnection.addIceCandidate(new RTCIceCandidate(t))})),Object(p.c)(Object(p.a)(c,"answers"),(function(e){var t=e.val();if(null===t||void 0===t?void 0:t.answer){var n=de.getState().participants[t.answer.userId].peerConnection,r=new RTCSessionDescription(t.answer);n.setRemoteDescription(r)}})),Object(p.c)(Object(p.a)(c,"answerCandidates"),(function(e){var t=e.val();t.userId&&de.getState().participants[t.userId].peerConnection.addIceCandidate(new RTCIceCandidate(t))}));case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),ce=function(){var e=Object(d.a)(u.a.mark((function e(t,n){var r,a,c,i;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=de.getState().participants[t].peerConnection,a=Object(p.a)(te,t),r.onicecandidate=function(e){e.candidate&&Object(p.h)(Object(p.a)(a,"answerCandidates"),Object(N.a)(Object(N.a)({},e.candidate.toJSON()),{},{userId:n}))},e.next=5,r.createAnswer();case 5:return c=e.sent,e.next=8,r.setLocalDescription(c);case 8:return i={type:c.type,sdp:c.sdp,userId:n},e.next=11,Object(p.j)(Object(p.h)(Object(p.a)(a,"answers")),{answer:i});case 11:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),ie={mainStream:null,participants:{},currentUser:null},se={iceServers:[{urls:["stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun.l.google.com:19302","stun:stun3.l.google.com:19302","stun:stun4.l.google.com:19302","stun:stun.services.mozilla.com"]}],iceCandidatePoolSize:10},oe=function(){return"#"+Math.floor(16777215*Math.random()).toString(16)},ue=function(e,t,n){var r=new RTCPeerConnection(se);n.getTracks().forEach((function(e){r.addTrack(e,n)}));var a=Object.keys(e)[0],c=Object.keys(t)[0],i=[a,c].sort((function(e,t){return e.localeCompare(t)}));return e[a].peerConnection=r,i[0]!==c&&re(r,i[0],i[1]),e},de=Object(ee.a)((function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ie,t=arguments.length>1?arguments[1]:void 0;if(t.type===V){var n=t.payload;return e=Object(N.a)(Object(N.a)({},e),n)}if(t.type===L){var r=t.payload,a=Object.keys(e.currentUser)[0],c=Object.keys(r.newUser)[0];e.mainStream&&a!==c&&(r.newUser=ue(r.newUser,e.currentUser,e.mainStream)),a===c&&(r.newUser[c].currentUser=!0),r.newUser[c].avatarColor=oe();var i=Object(N.a)(Object(N.a)({},e.participants),r.newUser);return e=Object(N.a)(Object(N.a)({},e),{},{participants:i})}if(t.type===_){var s=t.payload,o=Object(N.a)({},e.participants),u=Object.keys(s.currentUser)[0];return s.currentUser[u].avatarColor=oe(),ae(u),e=Object(N.a)(Object(N.a)({},e),{},{currentUser:Object(N.a)({},s.currentUser),participants:o})}if(t.type===z){var d=t.payload,j=Object(N.a)({},e.participants);return delete j[d.id],e=Object(N.a)(Object(N.a)({},e),{},{participants:j})}if(t.type===F){var b=t.payload,l=Object.keys(e.currentUser)[0];return ne(l,b.currentUser),e.currentUser[l]=Object(N.a)(Object(N.a)({},e.currentUser[l]),b.currentUser),e=Object(N.a)(Object(N.a)({},e),{},{currentUser:Object(N.a)({},e.currentUser)})}if(t.type===B){var p=t.payload,f=Object.keys(p.newUser)[0];p.newUser[f]=Object(N.a)(Object(N.a)({},e.participants[f]),p.newUser[f]);var O=Object(N.a)(Object(N.a)({},e.participants),p.newUser);return e=Object(N.a)(Object(N.a)({},e),{},{participants:O})}return e}));i.a.render(Object(k.jsx)(a.a.StrictMode,{children:Object(k.jsx)(M.a,{store:de,children:Object(k.jsx)(G,{children:Object(k.jsx)(X,{})})})}),document.getElementById("root")),$()}},[[76,1,2]]]);
//# sourceMappingURL=main.4b6e496a.chunk.js.map